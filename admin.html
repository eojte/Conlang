<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Conlang Admin Panel</title>
  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 600px; margin: auto; }
    input, select, button, textarea { margin: 5px 0; width: 100%; padding: 8px; }
    #dictionary { margin-top: 20px; }
    .entry { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; }
    .entry-buttons { display: flex; justify-content: space-between; margin-top: 5px; }
  </style>
</head>
<body>
  <h1>Conlang Admin Panel</h1>

  <label for="token">GitHub Token:</label>
  <input type="password" id="token" placeholder="Paste your GitHub token here" />

  <label for="english">English:</label>
  <input id="english" />

  <label for="conlang">Conlang:</label>
  <input id="conlang" />

  <label for="category">Category:</label>
  <select id="category">
    <option value="noun">Noun</option>
    <option value="verb">Verb</option>
    <option value="adj">Adjective</option>
    <option value="other">Other</option>
  </select>

  <label for="root">Root (optional):</label>
  <input id="root" />

  <button onclick="addEntry()">Add / Update</button>
  <button onclick="saveChanges()">Save to GitHub</button>

  <div id="dictionary"></div>

  <script>
    const username = "eojte";
    const repo = "Conlang";
    const filePath = "conlang_dict.json";
    let dictionary = [];
    let fileSha = "";

    async function fetchDictionary() {
      const url = `https://api.github.com/repos/${username}/${repo}/contents/${filePath}`;
      const res = await fetch(url);
      const data = await res.json();
      fileSha = data.sha;
      const content = atob(data.content);
      dictionary = JSON.parse(content);
      renderDictionary();
    }

    function renderDictionary() {
      const container = document.getElementById("dictionary");
      container.innerHTML = "";
      dictionary.forEach((word, index) => {
        const div = document.createElement("div");
        div.className = "entry";
        div.innerHTML = `
          <strong>${word.english}</strong> - <em>${word.conlang}</em><br>
          Category: ${word.category}<br>
          Root: ${word.root || "None"}
          <div class="entry-buttons">
            <button onclick="editEntry(${index})">Edit</button>
            <button onclick="deleteEntry(${index})">Delete</button>
          </div>
        `;
        container.appendChild(div);
      });
    }

    function addEntry() {
      const english = document.getElementById("english").value.trim();
      const conlang = document.getElementById("conlang").value.trim();
      const category = document.getElementById("category").value;
      const root = document.getElementById("root").value.trim() || null;

      if (!english || !conlang) {
        alert("English and Conlang fields are required.");
        return;
      }

      const index = dictionary.findIndex(w => w.english.toLowerCase() === english.toLowerCase());
      const newEntry = { english, conlang, category, root };

      if (index >= 0) {
        dictionary[index] = newEntry;
      } else {
        dictionary.push(newEntry);
      }

      renderDictionary();
      document.getElementById("english").value = "";
      document.getElementById("conlang").value = "";
      document.getElementById("root").value = "";
    }

    function editEntry(index) {
      const word = dictionary[index];
      document.getElementById("english").value = word.english;
      document.getElementById("conlang").value = word.conlang;
      document.getElementById("category").value = word.category;
      document.getElementById("root").value = word.root || "";
    }

    function deleteEntry(index) {
      if (confirm("Are you sure you want to delete this word?")) {
        dictionary.splice(index, 1);
        renderDictionary();
      }
    }

    async function saveChanges() {
      const token = document.getElementById("token").value;
      if (!token) return alert("Token required!");

      const url = `https://api.github.com/repos/${username}/${repo}/contents/${filePath}`;
      const updatedContent = btoa(JSON.stringify(dictionary, null, 2));
      const res = await fetch(url, {
        method: "PUT",
        headers: {
          Authorization: `token ${token}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          message: "Update dictionary from admin panel",
          content: updatedContent,
          sha: fileSha
        })
      });

      if (res.ok) {
        alert("Dictionary saved!");
        fetchDictionary(); // Reload to get new SHA
      } else {
        alert("Failed to save. Check token and permissions.");
      }
    }

    fetchDictionary();
  </script>
</body>
</html>
